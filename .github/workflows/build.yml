name: Full iOS Build with Expo Bare

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name:  Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # 住专 转 -cache  注 砖转 lock file 住专

      - name:  Install dependencies
        run: |
          npm install
          npm install -g expo-cli

      - name:  Generate iOS folder
        # 砖砖 -clean  爪专 拽 砖 转拽转 ios
        run: npx expo prebuild --platform ios --no-install --clean

      - name: Ч Cleanup & Metro Cache Reset
        run: |
          rm -rf ios/Pods ios/Podfile.lock build dist
          mkdir -p dist
          # 拽  专   砖砖 -Import (拽 转) 转驻住
          rm -rf /tmp/metro-cache
          rm -rf /tmp/haste-map-*

      - name:  Patch Podfile & Install CocoaPods
        run: |
          if [ -f ios/Podfile ]; then
            # 专转 专住转 注 爪
            sed -i '' "s/platform :ios, .*/platform :ios, '13.4'/g" ios/Podfile
          fi
          
          cd ios
